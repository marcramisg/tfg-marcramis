<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIVE</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css" integrity="sha384-r4NyP46KrjDleawBgD5tp8Y7UzmLA05oM1iAEQ17CSuDqnUK2+k9luXQOfXJCJ4I" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 90px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            z-index: 99;
        }

        #sidebar li a:hover:not(.active) {
          color: #060606;
        }

        @media (max-width: 767.98px) {
            .sidebar {
                top: 11.5rem;
                padding: 0;
            }
        }
            
        .navbar {
            box-shadow: inset 0 -1px 0 rgba(0, 0, 0, .1);
        }

        @media (min-width: 767.98px) {
            .navbar {
                top: 0;
                position: sticky;
                z-index: 999;
            }
        }

        .sidebar .nav-link {
            color: #333;
        }

        .sidebar .nav-link.active {
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-light bg-light p-3">
        <div class="d-flex col-12 col-md-3 col-lg-2 mb-2 mb-lg-0 flex-wrap flex-md-nowrap justify-content-between">
            <a class="navbar-brand" href="#">
              <img src="/static/royal_flush_logo.png" alt="Logo" height="40">
                Manager interface
            </a>
            <button class="navbar-toggler d-md-none collapsed mb-3" type="button" data-toggle="collapse" data-target="#sidebar" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>

        <div class="col-12 col-md-4 col-lg-2">
            <input id="search-bar" class="form-control form-control-dark" type="text" placeholder="Search" aria-label="Search">
        </div>

        <div class="col-12 col-md-5 col-lg-8 d-flex align-items-center justify-content-md-end mt-3 mt-md-0">
            <div class="mr-3 mt-1">
                <a class="github-button" href="https://github.com/FranEnguix/five" data-color-scheme="no-preference: dark; light: light; dark: light;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star /franenguix/five">Star</a>
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-expanded="false">
                    {{ agent.jid }}
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <li><a class="dropdown-item" href="/spade/messages">{{ agent.traces.received().__len__() }} Messages</a></li>
                  <li><a class="dropdown-item" href="/manager/stop_all_agents">Stop ALL agents</a></li>
                  <li><a class="dropdown-item" href="/spade/stop">Stop manager</a></li>
                </ul>
              </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item pb-1 pt-1">
                          <a class="nav-link d-flex" aria-current="page" href="/manager/dashboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                            <span class="ml-2">Dashboard</span>
                          </a>
                        </li>
                        <li class="nav-item pb-1 pt-1">
                          <a class="nav-link d-flex disabled text-muted" href="/manager/project">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                            <span class="ml-2">Project</span>
                          </a>
                        </li>
                        <li class="nav-item pb-1 pt-1">
                          <a class="nav-link d-flex active" href="/manager/agents">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            <span class="ml-2">Agents</span>
                          </a>
                        </li>
                        <li class="nav-item pb-1 pt-1">
                          <a class="nav-link d-flex disabled text-muted" href="/manager/plots">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bar-chart-2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                            <span class="ml-2">Plots</span>
                          </a>
                        </li>
                        <li class="nav-item pb-1 pt-1">
                          <a class="nav-link d-flex disabled text-muted" href="/manager/plugins">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-layers"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                            <span class="ml-2">Plugins</span>
                          </a>
                        </li>
                        <li class="nav-item pb-1 pt-1 mr-2">
                            <a class="btn btn-sm btn-secondary ml-3 mt-2 disabled" href="#">
                                <svg width="1.2em" height="1.2em" viewBox="0 0 16 16" class="bi bi-book" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M1 2.828v9.923c.918-.35 2.107-.692 3.287-.81 1.094-.111 2.278-.039 3.213.492V2.687c-.654-.689-1.782-.886-3.112-.752-1.234.124-2.503.523-3.388.893zm7.5-.141v9.746c.935-.53 2.12-.603 3.213-.493 1.18.12 2.37.461 3.287.811V2.828c-.885-.37-2.154-.769-3.388-.893-1.33-.134-2.458.063-3.112.752zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                                </svg>
                                <span class="ml-2">FIVE ReadTheDocs</span>
                            </a>
                        </li>
                      </ul>
                </div>
            </nav>
            <main class="col-md-9 ml-sm-auto col-lg-10 px-md-4 py-4">
              
              <h1 class="h2">Agents</h1>

              <div id="filter-target" class="row mt-3">
                {% for key, value in agents[0]['agentes'].items() %}
                  <div class="col-12 col-xl-6 mb-4">
                    <div class="card {% if not value['available'] %}bg-light text-muted{% endif %}">
                      <h5 class="card-header">{{ value['jid'] }}</h5>
                      <div class="card-body">
                        <p>Name: {{ value['name'] }}</p>
                        <p>Observers: {{ value['observers'] | join(', ') }}</p>
                        <p>Neighbours: {{ value['neighbours'] | join(', ') }}</p>
                      </div>
                      <div class="m-2 me-auto">
                        <div class="btn-group" role="group">
                          {% if value['available']%}
                            <button type="button" class="btn btn-lg btn-outline-danger" data-jid="{{ value['jid'] }}" onclick="stopAgent(this)">
                              <i class="fa-solid fa-stop"></i>
                              <span class="ml-1">Stop Agent</span>
                            </button>
                          {% else %}
                            <button type="button" class="btn btn-lg btn-outline-success" data-jid="{{ value['jid'] }}" onclick="resumeAgent(this)">
                              <i class="fa-solid fa-play"></i>
                              <span class="ml-1">Resume Agent</span>
                            </button>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <div id="graph-container" style="width: 100%; height: 500px; border: 1px solid #ddd; margin-top: 2rem; position: relative;">
                <!-- Botón info -->
                <button type="button" class="btn btn-info position-absolute" style="background-color: transparent; top: 10px; right: 10px; z-index: 10;" data-bs-toggle="modal" data-bs-target="#infoModal">
                  ℹ️
                </button>
              </div>

              <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="infoModalLabel">Instrucciones del Grafo</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                      <ul>
                        <li>Presiona <strong>C</strong> para activar/desactivar el modo de creación de aristas</li>
                        <li>En modo creación: haz clic en dos nodos para crear una arista</li>
                        <li>Haz clic en una arista para eliminarla</li>
                        <li>Presiona <strong>Escape</strong> para cancelar la creación de aristas</li>
                        <li>Presiona <strong>Delete</strong> para eliminar aristas seleccionadas</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              

              <footer class="pt-5 d-flex justify-content-between">
                  <span class="d-flex justify-content-center align-items-center">Copyright © 2021-2024 <a class="ml-1" href="https://github.com/FranEnguix/five">FIVE</a></span>
                  <ul class="nav m-0">
                      <li class="nav-item">
                        <a class="nav-link text-secondary" href="https://github.com/FranEnguix/five/blob/main/LICENSE">License</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link text-secondary" href="mailto:enguix.fco@gmail.com">Contact</a>
                      </li>
                    </ul>
              </footer>


          </main>
        </div>
    </div>
    
    <script>
      // Filter with search-bar
      $(document).ready(function(){
        $("#search-bar").on("keyup", function() {
          var value = $(this).val().toLowerCase();
          $("#filter-target div").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
          });
        });
      });

    </script>
    <script>
      let cy;

      function getNodeColor(coalitionId) {
          const colors = {
              1: '#FF6B6B',   // Rojo
              2: '#4ECDC4',   // Verde azulado
              3: '#45B7D1',   // Azul
              4: '#96CEB4',   // Verde menta
              5: '#FFEAA7',   // Amarillo
              6: '#DDA0DD',   // Púrpura
              7: '#98D8C8',   // Verde agua
              8: '#F7DC6F',   // Amarillo dorado
              9: '#BB8FCE',   // Lavanda
              10: '#85C1E9'   // Azul cielo
          };
          
          return colors[coalitionId] || '#95A5A6'; // Gris por defecto
      }

      async function loadGraphData() {
          try {
              const response = await fetch('/api/graph-data');
              
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const graphData = await response.json();
              console.log('Graph data loaded:', graphData);
              
              cy = cytoscape({
                  container: document.getElementById('graph-container'),
                  elements: graphData,
                  style: [
                      {
                          selector: 'node',
                          style: {
                              'background-color': function(ele) {
                                  return getNodeColor(ele.data('coalition_id'));
                              },
                              'label': 'data(id)',
                              'text-valign': 'center',
                              'text-halign': 'center',
                              'color': 'white',
                              'font-size': '14px',
                              'font-weight': 'bold',
                              'font-family': 'Arial, sans-serif',
                              'width': '60px',
                              'height': '60px',
                              'border-width': '3px',
                              'border-color': '#fff',
                              'text-outline-width': '2px',
                              'text-outline-color': '#000',
                              'transition-property': 'background-color, border-color, width, height',
                              'transition-duration': '0.3s'
                          }
                      },
                      {
                          selector: 'node:selected',
                          style: {
                              'background-color': '#ff1744',
                              'border-color': '#fff',
                              'border-width': '5px',
                              'width': '90px',
                              'height': '90px'
                          }
                      },
                      {
                          selector: 'node:active',
                          style: {
                              'background-color': '#ffd700',
                              'border-color': '#ff6347',
                              'width': '80px',
                              'height': '80px'
                          }
                      },
                      {
                          selector: 'edge',
                          style: {
                              'width': 4,
                              'line-color': '#666',
                              'curve-style': 'bezier',
                              'opacity': 0.8,
                              'transition-property': 'line-color, width',
                              'transition-duration': '0.3s'
                          }
                      },
                      {
                          selector: 'edge:selected',
                          style: {
                              'line-color': '#ff1744',
                              'width': 8
                          }
                      }
                  ],
                  layout: {
                      name: 'circle',
                      radius: 200,
                      animate: true,
                      animationDuration: 1000
                  }
              });
              
              setupGraphInteractions();
              
          } catch (error) {
              console.error('Error loading graph data:', error);
          }
      }

      let isCreatingEdge = false;
      let sourceNode = null;
      let tempEdge = null;

      function setupGraphInteractions() {
          // Crear aristas
          cy.on('tap', 'node', function(evt) {
              const node = evt.target;
              
              if (isCreatingEdge) {
                  if (!sourceNode) {
                      // Primer nodo
                      sourceNode = node;
                      node.select();
                      console.log('Nodo origen seleccionado:', node.id());
                  } else if (sourceNode.id() !== node.id()) {
                      // Segundo nodo - arista
                      const edgeId = `${sourceNode.id()}-${node.id()}`;
                      
                      // Verificar existencia
                      const existingEdge = cy.getElementById(edgeId) || cy.getElementById(`${node.id()}-${sourceNode.id()}`);
                      
                      if (existingEdge.length === 0) {
                          createEdge(sourceNode.id(), node.id());
                      } else {
                          console.log('Ya existe una arista entre estos nodos');
                      }
                      
                      // Reset modo creación
                      resetEdgeCreation();
                  }
              }
          });
          
          // Eliminar aristas
          cy.on('tap', 'edge', function(evt) {
              const edge = evt.target;
              if (confirm('¿Deseas eliminar esta arista?')) {
                  deleteEdge(edge.id());
              }
          });
          
          // Cancelar creación al hacer clic en el fondo
          cy.on('tap', function(evt) {
              if (evt.target === cy && isCreatingEdge) {
                  resetEdgeCreation();
              }
          });
          
          // Eventos de teclado
          document.addEventListener('keydown', function(evt) {
              switch(evt.key) {
                  case 'c':
                  case 'C':
                      toggleEdgeCreationMode();
                      break;
                  case 'Escape':
                      resetEdgeCreation();
                      break;
                  case 'Delete':
                  case 'Backspace':
                      deleteSelectedElements();
                      break;
              }
          });
      }

      function toggleEdgeCreationMode() {
          isCreatingEdge = !isCreatingEdge;
          
          if (isCreatingEdge) {
              console.log('Modo creación de aristas activado. Selecciona dos nodos.');
              document.body.style.cursor = 'crosshair';
          } else {
              resetEdgeCreation();
              console.log('Modo creación de aristas desactivado.');
          }
      }

      function resetEdgeCreation() {
          isCreatingEdge = false;
          sourceNode = null;
          cy.nodes().unselect();
          document.body.style.cursor = 'default';
      }

      async function createEdge(sourceId, targetId) {
          const edgeId = `${sourceId}-${targetId}`;
          const reverseEdgeId = `${targetId}-${sourceId}`;
          
          try {
            const existingEdge = cy.getElementById(edgeId);
            const existingReverseEdge = cy.getElementById(reverseEdgeId);
              if (existingEdge.empty() && existingReverseEdge.empty()) {
                cy.add({
                    group: 'edges',
                    data: {
                        id: edgeId,
                        source: sourceId,
                        target: targetId
                    }
                });
              
                console.log('Arista creada:', edgeId);
              
              
                await syncGraphWithBackend('create_edge', {
                    source: sourceId,
                    target: targetId,
                    id: edgeId
                });
              } else{
                console.error('Error creando arista');
              }
              
          } catch (error) {
              console.error('Error creando arista:', error);
              // Revertir cambio local si falla el backend
              cy.getElementById(edgeId).remove();
          }
      }

      async function deleteEdge(edgeId) {  
        try {
              const edge = cy.getElementById(edgeId);
              if (!edge.empty()) {
                const edgeData = {
                    id: edgeId,
                    source: edge.source().id(),
                    target: edge.target().id()
                };
                
                // Eliminar arista localmente
                edge.remove();
                
                console.log('Arista eliminada:', edgeId);
                
                // Sincronizar con el backend
                await syncGraphWithBackend('delete_edge', edgeData);
              } else {
                console.error('Error eliminando arista');
              }
              
          } catch (error) {
              console.error('Error eliminando arista:', error);
              // Recargar el grafo si hay error
              loadGraphData();
          }
      }

      function deleteSelectedElements() {
          const selectedEdges = cy.edges(':selected');
          
          selectedEdges.forEach(edge => {
              if (confirm(`¿Deseas eliminar la arista ${edge.id()}?`)) {
                  deleteEdge(edge.id());
              }
          });
      }

      async function syncGraphWithBackend(action, data) {
          try {
              const response = await fetch('/api/graph-update', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      action: action,
                      data: data,
                      timestamp: Date.now()
                  })
              });
              
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const result = await response.json();
              console.log('Grafo sincronizado con backend:', result);

              location.reload();
              
              return result;
              
          } catch (error) {
              console.error('Error sincronizando con backend:', error);
              throw error;
          }
      }

      function getCurrentGraphState() {
          return {
              nodes: cy.nodes().map(node => ({
                  data: node.data(),
                  position: node.position()
              })),
              edges: cy.edges().map(edge => ({
                  data: edge.data()
              }))
          };
      }

      async function saveGraphState() {
          try {
              const graphState = getCurrentGraphState();
              await syncGraphWithBackend('save_state', graphState);
              console.log('Estado del grafo guardado');
          } catch (error) {
              console.error('Error guardando estado:', error);
          }
      }

      document.addEventListener('DOMContentLoaded', function() {
          loadGraphData();
      });

      window.graphUtils = {
          toggleEdgeCreationMode,
          saveGraphState,
          getCurrentGraphState,
      };
    </script>
    <script>
      function stopAgent(button) {
        const jid = button.getAttribute("data-jid");

        fetch(`/manager/pause_agent`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jid: jid })
        })
        .then(response => response.json())
        .then(data => {
          console.log('Agente detenido:', data);
          alert(`Agente ${data.jid} detenido correctamente`);
          location.reload();
        })
        .catch(error => console.error('Error:', error));
      }
    </script>
    <script> 
      function resumeAgent(button) {
        const jid = button.getAttribute("data-jid");

        fetch(`/manager/resume_agent`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jid: jid })
        })
        .then(response => response.json())
        .then(data => {
          console.log('Agente reanudado:', data);
          alert(`Agente ${data.jid} reanudado correctamente`);
          if (window.websocket) {
              window.websocket.close();
          }
          location.reload();
        })
        .catch(error => console.error('Error:', error));
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script> -->
    <!-- Github buttons -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
</body>
</html>